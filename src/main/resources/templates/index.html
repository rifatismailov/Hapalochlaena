<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Upload File</title>
    <link rel="stylesheet" href="/style.css">
</head>
<body>
<div class="container">
    <div class="card">
        <h3>Upload Files</h3>
        <form id="uploadForm" enctype="multipart/form-data" class="drop_box">
            <header><h4>Select File</h4></header>
            <p>Files Supported: DOC, DOCX, XLS, XLSX, PPT, PPTX, TXT</p>
            <input type="file" name="file" id="fileInput" required accept=".doc,.docx,.xls,. xlsx,.ppt,.pptx,.txt">
            <button class="btn" type="submit">Upload</button>
        </form>
        <div id="result" style="margin-top: 20px; text-align: center; font-weight: bold;"></div>
    </div>
</div>

<!-- ‚úÖ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è SockJS —ñ STOMP -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

<script>
    let stompClient = null;
    const clientId = "client-" + Date.now(); // üî• —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π –ª–∏—à–µ –æ–¥–∏–Ω —Ä–∞–∑

    function connectWebSocket() {
        const socket = new SockJS('/ws?clientId=' + clientId);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            console.log("‚úÖ WebSocket –∑ º—î–¥–Ω–∞–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");

            // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å—Ç–∞—Ç—É—Å
            stompClient.subscribe('/user/queue/status', (message) => {
                const statusText = message.body;
                const statusDiv = document.getElementById("result");
                console.log("üì® –°—Ç–∞—Ç—É—Å:", statusText);
                statusDiv.innerText = "üü° –°—Ç–∞—Ç—É—Å: " + statusText;
            });

            // –ü—ñ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            stompClient.subscribe('/user/queue/result', (message) => {
                const resultText = message.body;
                const resultDiv = document.getElementById("result");
                console.log("üì® –†–µ–∑—É–ª—å—Ç–∞—Ç:", resultText);

                resultDiv.innerHTML = `
                    üìÑ ‚úÖ –û–±—Ä–æ–±–ª–µ–Ω–æ: ${resultText}<br><br>
                    <form action="/result" method="get">
                        <input type="hidden" name="key" value="${resultText}">
                        <button class="btn" type="submit">–ü–æ–¥–∏–≤–∏—Ç–∏—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
                    </form>
                `;
            });
        }, (error) => {
            console.error("‚ùå WebSocket –ø–æ–º–∏–ª–∫–∞:", error);
        });
    }

    window.onload = connectWebSocket;

    document.getElementById('uploadForm').addEventListener('submit', function (e) {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        fetch("/upload?clientId=" + clientId, {
            method: "POST",
            body: formData
        })
            .then(res => res.text())
            .then(msg => {
                document.getElementById("result").innerText = "üì§ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: " + msg;
            })
            .catch(err => {
                document.getElementById("result").innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞: " + err;
            });
    });
</script>

</body>
</html>
